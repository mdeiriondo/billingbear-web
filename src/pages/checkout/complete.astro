---
import Layout from '../../layouts/Layout.astro';
import { getOrder } from '../../lib/woocommerce';

export const prerender = false;

const orderIdParam = Astro.url.searchParams.get('order');

if (!orderIdParam) {
  return Astro.redirect('/vouchers', 302);
}

let order;
let error: string | null = null;

try {
  const orderIdNum = parseInt(orderIdParam, 10);
  if (isNaN(orderIdNum)) {
    throw new Error('Invalid order ID');
  }
  order = await getOrder(orderIdNum);
} catch (err) {
  error = err instanceof Error ? err.message : 'Order not found';
}

const logoUrl = "https://billingbearpark.com/wp-content/uploads/2020/10/cropped-treat2-2.png";
---

<Layout title={`Order Confirmation - Order #${orderIdParam} | Billingbear Park`}>
  <nav class="bg-brand-green text-white py-4 px-6 sticky top-0 z-[100] shadow-xl border-b border-white/5">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <a href="/" class="flex items-center gap-4 group">
        <img src={logoUrl} alt="Logo" class="h-8 md:h-10 w-auto brightness-0 invert" />
        <div class="hidden md:block border-l border-white/20 pl-4">
          <span class="font-serif italic text-lg leading-none block">Order Confirmation</span>
        </div>
      </a>
      <a href="/vouchers" class="text-[9px] md:text-[10px] uppercase font-bold tracking-widest bg-white/10 hover:bg-white/20 border border-white/20 px-4 py-2 transition-all leading-none">
        &larr; Back to Vouchers
      </a>
    </div>
  </nav>

  <main class="bg-brand-cream min-h-screen py-12 px-6">
    <div class="max-w-2xl mx-auto">
      {error ? (
        <div class="bg-white border border-red-200 rounded-sm p-8 text-center">
          <div class="text-red-600 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h2 class="font-serif text-2xl text-brand-green mb-2 italic">Order Not Found</h2>
          <p class="text-brand-dark/70 mb-6">{error}</p>
          <a href="/vouchers" class="inline-block bg-brand-green text-white px-8 py-3 text-[10px] font-bold uppercase tracking-widest hover:bg-brand-gold transition-all leading-none">
            Return to Vouchers
          </a>
        </div>
      ) : order ? (
        <>
          <div class="bg-white border border-brand-stone rounded-sm shadow-lg overflow-hidden mb-6">
            <div class="bg-brand-green text-white p-6 text-center">
              <div class="mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 mx-auto text-brand-gold" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <span class="text-brand-gold uppercase tracking-widest text-[10px] font-bold block mb-2">Payment Successful</span>
              <h1 class="font-serif text-3xl md:text-4xl italic leading-tight">Thank You!</h1>
              <p class="text-white/80 mt-2 text-sm">Your order has been confirmed</p>
            </div>

            <div class="p-6 md:p-8">
              <div class="mb-6">
                <h2 class="font-serif text-xl text-brand-green mb-4 italic">Order Details</h2>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-brand-dark/70">Order Number:</span>
                    <span class="font-medium text-brand-dark">#{order.id}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-brand-dark/70">Order Status:</span>
                    <span class="font-medium text-brand-green capitalize">{order.status}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-brand-dark/70">Order Date:</span>
                    <span class="font-medium text-brand-dark">{new Date(order.date_created).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</span>
                  </div>
                  {order.meta_data?.find((m: any) => m.key === 'recipient_email') && (
                    <div class="flex justify-between">
                      <span class="text-brand-dark/70">Confirmation Email:</span>
                      <span class="font-medium text-brand-dark">{order.meta_data.find((m: any) => m.key === 'recipient_email')?.value}</span>
                    </div>
                  )}
                </div>
              </div>

              <div class="border-t border-brand-stone pt-6 mb-6">
                <h3 class="font-serif text-lg text-brand-green mb-4 italic">Items Ordered</h3>
                <table class="w-full">
                  <thead class="border-b border-brand-stone">
                    <tr>
                      <th class="text-left py-3 text-brand-green uppercase tracking-widest text-[10px] font-bold">Product</th>
                      <th class="text-right py-3 text-brand-green uppercase tracking-widest text-[10px] font-bold">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    {order.line_items.map((item: any) => (
                      <tr class="border-b border-brand-stone/50">
                        <td class="py-3">
                          <div class="font-medium text-brand-dark">{item.name}</div>
                          {order.meta_data?.find((m: any) => m.key === 'recipient_name') && (
                            <div class="text-sm text-brand-dark/60 mt-1">
                              For: {order.meta_data.find((m: any) => m.key === 'recipient_name')?.value}
                            </div>
                          )}
                          {order.meta_data?.find((m: any) => m.key === 'recipient_message') && (
                            <div class="text-sm text-brand-dark/60 mt-1 italic">
                              "{order.meta_data.find((m: any) => m.key === 'recipient_message')?.value}"
                            </div>
                          )}
                        </td>
                        <td class="py-3 text-right font-serif text-brand-green text-lg italic">£{parseFloat(item.total).toFixed(2)}</td>
                      </tr>
                    ))}
                  </tbody>
                  <tfoot class="border-t-2 border-brand-stone">
                    <tr>
                      <td class="py-4 text-right font-bold text-brand-green uppercase tracking-widest text-[10px]">Total Paid:</td>
                      <td class="py-4 text-right font-serif text-brand-green text-2xl italic">£{parseFloat(order.total).toFixed(2)}</td>
                    </tr>
                  </tfoot>
                </table>
              </div>

              <div class="bg-brand-cream border-l-4 border-brand-gold p-4 mb-6">
                <p class="text-sm text-brand-dark/70">
                  <strong class="text-brand-green">What's Next?</strong><br />
                  You will receive a confirmation email shortly with your voucher details. If you have any questions, please contact us.
                </p>
              </div>

              <div class="flex gap-4">
                <a href="/vouchers" class="flex-1 bg-brand-green text-white px-6 py-3 text-[10px] font-bold uppercase tracking-widest hover:bg-brand-gold transition-all text-center leading-none">
                  Browse More Vouchers
                </a>
                <a href="/" class="flex-1 border border-brand-stone text-brand-dark px-6 py-3 text-[10px] font-bold uppercase tracking-widest hover:bg-brand-stone/50 transition-all text-center leading-none">
                  Return Home
                </a>
              </div>
            </div>
          </div>
        </>
      ) : null}
    </div>
  </main>
</Layout>
